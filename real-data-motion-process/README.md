# 真实动作数据处理流程

这个文件夹包含了从原始动作捕捉数据到最终训练数据的完整处理流程。整个流程分为四个步骤，每个步骤解决特定的数据处理问题。

## 📋 处理流程概览

```
📹 原始动捕CSV数据 + 🤖 机器人PKL数据
     ↓
🔧 Step1: 动捕数据遮挡修复
     ↓
⏰ Step2: 时间对齐与数据融合
     ↓
🧭 Step3: 机器人朝向调整
     ↓
📦 Step4: PKL文件批量合并
     ↓
✅ 最终训练数据集
```

## 🔧 Step1: 动捕数据遮挡修复
**文件**: `step1-fix_mocap_occlusion.py`

### 功能说明
修复动作捕捉系统中因遮挡、反射或系统故障导致的异常值，确保数据质量。

### 主要特点
- **智能异常检测**: 使用Z-Score、跳变检测、中值滤波三种方法组合
- **安全插值修复**: 使用三次样条插值，防止产生不合理的外推值
- **批量处理**: 自动处理文件夹中的所有CSV文件
- **可视化验证**: 生成修复前后对比图

### 输入输出
- **输入**: 原始动捕CSV文件 (ASAP格式)
- **输出**: 修复后的CSV文件 + 可视化图表

### 使用场景
- 清洗原始动捕数据中的噪声和异常
- 为后续处理提供高质量的基础数据

---

## ⏰ Step2: 时间对齐与数据融合
**文件**: `step2-time_alignment_fusion.py`

### 功能说明
将动作捕捉数据与机器人仿真数据进行精确的时间同步和数据融合。

### 主要特点
- **智能起始点检测**: 自动检测真正的运动开始时刻
- **精确时间裁剪**: 根据PKL持续时间精确裁剪CSV数据
- **坐标系转换**: 支持多种XY映射模式和机器人朝向配置
- **高精度插值**: 将动捕数据插值到PKL的精确时间点
- **数据完整性**: 修复pose_aa计算，确保关节角度正确

### 输入输出
- **输入**: 修复后的CSV文件 + 机器人PKL文件 + XML配置文件
- **输出**: 时间对齐的融合PKL文件 + 处理结果可视化

### 配置参数
- `xy_mapping_mode`: 坐标映射方式 (normal/swapped)
- `robot_orientation_mode`: 机器人朝向 (forward/backward/left/right)

### 使用场景
- 制作模仿学习训练数据
- 人机动作对比分析
- 多模态数据融合

---

## 🧭 Step3: 机器人朝向调整
**文件**: `step3-adjust_robot_orientation.py`

### 功能说明
批量调整PKL文件中机器人轨迹数据的朝向，解决朝向不一致问题。

### 主要特点
- **完整3D旋转**: 处理位置、速度、姿态、角速度、关节位置等所有相关数据
- **数学正确性**: 使用标准的3D旋转变换和四元数运算
- **批量处理**: 自动处理目录中的所有PKL文件
- **数据完整性**: 保持原始数据结构，只旋转必要的字段

### 旋转内容
- ✅ 根部位置轨迹 (`root_trans_offset`)
- ✅ 线性速度 (`root_lin_vel`)
- ✅ 姿态四元数 (`root_rot`)
- ✅ 角速度 (`root_ang_vel`)
- ✅ SMPL关节位置 (`smpl_joints`)
- ✅ 姿态角轴表示 (`pose_aa`)

### 输入输出
- **输入**: 时间对齐后的PKL文件
- **输出**: 朝向调整后的PKL文件 (文件名包含旋转角度)

### 使用场景
- 统一机器人面向方向
- 修正坐标系不一致问题
- 数据标准化预处理

---

## 📦 Step4: PKL文件批量合并
**文件**: `step4-merge_pkl_files.py`

### 功能说明
将多个分散的PKL文件合并成一个统一的训练数据集。

### 主要特点
- **智能文件扫描**: 自动扫描指定目录中的所有PKL文件
- **数据重组**: 将所有motion数据重新编号为motion0, motion1, motion2...
- **格式验证**: 自动检测和处理不同的PKL文件格式
- **完整性检查**: 验证合并结果的数据完整性

### 输入输出
- **输入**: 朝向调整后的多个PKL文件
- **输出**: 合并后的单个PKL文件 (包含所有motion数据)

### 文件命名
输出文件格式: `YYYYMMDD_HHMMSS_merged_Nmotions.pkl`

### 使用场景
- 数据集整理和管理
- 训练数据的统一格式化
- 多个实验结果的合并

---

## 🚀 快速使用指南

### 1. 准备数据
- 将原始动捕CSV文件放在指定目录
- 准备对应的机器人PKL文件
- 确保XML配置文件路径正确

### 2. 按顺序执行步骤
```bash
# Step1: 修复动捕数据异常值
python step1-fix_mocap_occlusion.py

# Step2: 时间对齐和数据融合
python step2-time_alignment_fusion.py

# Step3: 调整机器人朝向
python step3-adjust_robot_orientation.py

# Step4: 合并PKL文件
python step4-merge_pkl_files.py
```

### 3. 检查输出
每个步骤都会在指定的输出目录生成处理结果和可视化文件。

## ⚙️ 配置说明

### 文件路径配置
每个步骤的脚本都包含配置区域，需要根据实际环境修改：
- 输入文件/目录路径
- 输出目录路径
- 处理参数设置

### 依赖库要求
```python
pandas>=1.3.0
numpy>=1.20.0
scipy>=1.7.0
matplotlib>=3.4.0
joblib>=1.0.0
```

## 📊 数据质量保证

- **异常值处理**: Step1确保数据清洁度
- **时间精度**: Step2保证毫秒级时间对齐
- **空间一致性**: Step3确保朝向统一
- **格式标准化**: Step4提供统一的数据格式

## 🎯 最终输出

完成所有步骤后，您将获得：
- ✅ 高质量的清洁数据
- ✅ 精确时间对齐的融合数据
- ✅ 朝向一致的机器人轨迹
- ✅ 统一格式的训练数据集
 